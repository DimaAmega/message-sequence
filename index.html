<!DOCTYPE html>
<meta charset="utf-8">
<style>
    .class-rect {
        border: 1px;
        fill: white;
        stroke-width: 1px;
        stroke: black;
    }

    .class-label {
        font-size: x-small;
        font-weight: bold;
    }

    .message-rect {
        border: 1px;
        fill: green;
        stroke-width: 1px;
        stroke: black;
    }

    div.tooltip {
        position: absolute;
        text-align: center;
        padding: 2px;
        font: 12px sans-serif;
        background: lightsteelblue;
        border: 0;
        border-radius: 8px;
    }

</style>
<body>
<script src="https://d3js.org/d3.v5.min.js"></script>
<!--<script src="https://cdn.jsdelivr.net/npm/d3-path@3"></script>-->
<script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.4/lodash.min.js"></script>
<svg id="chart1" width="960" height="600"></svg>

<script>
    console.log(d3.version)

    /**
     * @param {Object[]} data
     * @param {string} data.sender
     * @param {string} data.receiver
     * @param {string} data.label
     * @param {string} data.tooltipMessage
     * @param {string} data.startTs
     * @param {string} data.endTs
     */
    function processData(data) {
        const senders = d3.set(data.map(d => d.sender)).values();
        const receivers = d3.set(data.map(d => d.receiver)).values();
        const classes = _.union(senders, receivers);
        // console.log(senders);
        console.log(classes);

        const VERT_SPACE = 170;
        const VERT_PAD = 20;

        const svg = d3.select('svg#chart1'),
            margin = {top: 20, right: 50, bottom: 100, left: 80},
            width = VERT_SPACE * classes.length - margin.left - margin.right
            // width = +svg.attr('width') - margin.left - margin.right,
            // height = +svg.attr('height') - margin.top - margin.bottom,
            g = svg.append('g').attr('transform', 'translate(' + margin.left + ',' + margin.top + ')');

        // Graph title
        g.append('text')
            .attr('x', (width / 2))
            .attr('y', 0 - (margin.top / 3))
            .attr('text-anchor', 'middle')
            .style('font-size', '16px')
            .text('Sequence diagram');

        const X_PAD = 100;
        const Y_PAD = 30;
        console.log(classes.length);

        const maxTs = data.reduce((currentMax, value) =>
            (currentMax.endTs > value.endTs) ? currentMax : value
        ).endTs
        const MESSAGE_SPACE = 30;
        console.log(maxTs + 100);
        svg.attr("height", Y_PAD + maxTs + 200);
        svg.attr("width", X_PAD + VERT_SPACE * classes.length)

        const MESSAGE_LABEL_X_OFFSET = -40;
        const MESSAGE_LABEL_Y_OFFSET = 75;
        const MESSAGE_ARROW_Y_OFFSET = 80;

        const CLASS_WIDTH = VERT_SPACE - 10;
        // const CLASS_LABEL_X_OFFSET = -30;
        // const CLASS_LABEL_Y_OFFSET = 25;

        // Draw vertical lines
        classes.forEach((c, i) => {
            svg.append("line")
                .style("stroke", "#888")
                .attr("x1", X_PAD + i * VERT_SPACE)
                .attr("y1", Y_PAD)
                .attr("x2", X_PAD + i * VERT_SPACE)
                .attr("y2", MESSAGE_ARROW_Y_OFFSET + maxTs + 40);
        });

        // Draw classes
        classes.forEach((c, i) => {
            const x = X_PAD + i * VERT_SPACE;
            const g = svg.append("g")
                .attr("transform", "translate(" + x + "," + Y_PAD + ")")
                .attr("class", "class-rect");
            g.append("rect")
                .attr("x", -CLASS_WIDTH / 2)
                .attr("y", 0)
                .attr("width", CLASS_WIDTH)
                .attr("height", "24px");
        });

        // Draw class labels
        classes.forEach((c, i) => {
            const x = X_PAD + i * VERT_SPACE;
            svg.append("g")
                .attr("transform", "translate(" + x + "," + Y_PAD + ")")
                .append("text")
                .attr("class", "class-label")
                .attr("text-anchor", "middle")
                .text(() => c)
                .attr("dy", "16px");
        });

        function makeArc(xStart, yStart, xEnd, yEnd, context) {
            const xMid = xStart + VERT_SPACE / 2,
                  yMid = (yEnd + yStart) / 2,
                  radius = (yEnd - yStart) / 2;
            context.moveTo(xStart, yStart);
            context.arcTo(xMid, yMid, xEnd, yEnd, radius);
            context.lineTo(xEnd, yEnd);
            return context;
        }

        // Append div with tooltip
        const tooltipDiv = d3.select("body").append("div")
            .attr("class", "tooltip")
            .attr("show", false)
            .style("opacity", 0);

        const onClickClosure = (message) => {
            return () => {
                if (tooltipDiv.attr("show") === "true") {
                    tooltipDiv.attr("show", false)
                        .style("pointer-events", "none")
                        .transition()
                        .duration(300)
                        .style("opacity", 0)
                } else {
                    tooltipDiv.attr("show", true)
                        .style("pointer-events", "auto")
                        .html(
                            "from: " + message.sender
                            + "<br/>to: " + message.receiver
                            + "<br/>" + message.tooltipMessage
                            + "<br/>started: " + message.startTs
                            + "<br/>finished: " + message.endTs
                        )
                        .style("left", (d3.event.pageX) + "px")
                        .style("top", (d3.event.pageY - 28) + "px")
                        .transition()
                        .duration(200)
                        .style("opacity", 1)
                }
            }
        }

        // Draw message arrows
        data.forEach((m, i) => {
            const xStart = X_PAD + classes.indexOf(m.sender) * VERT_SPACE
            const xEnd = X_PAD + classes.indexOf(m.receiver) * VERT_SPACE
            const yStart = MESSAGE_ARROW_Y_OFFSET + m.startTs;
            const yEnd = MESSAGE_ARROW_Y_OFFSET + m.endTs;

            if (m.sender === m.receiver) {
                svg.append("path")
                    .style("stroke", "black")
                    .attr("marker-end", "url(#end)")
                    .attr("fill", "none")
                    .attr("d", makeArc(xStart, yStart, xEnd, yEnd, d3.path()))
                    .on("click", onClickClosure(m));
            } else {
                svg.append("line")
                    .style("stroke", "black")
                    .attr("x1", xStart)
                    .attr("y1", yStart)
                    .attr("x2", xEnd)
                    .attr("y2", yEnd)
                    .attr("marker-end", "url(#end)")
                    .on("click", onClickClosure(m));
            }

            svg.append("g")
                .attr("transform", "translate(" + xStart + "," + yStart + ")")
                .append("text")
                .attr("dx", "5px")
                .attr("dy", "-2px")
                .attr("text-anchor", "begin")
                .style("font-size", "12px")
                .text(() => m.label)
                .on("click", onClickClosure(m));
        });

        // Draw message timestamps
        data.forEach((m, i) => {
            const xPos = X_PAD + MESSAGE_LABEL_X_OFFSET;
            const yPosStart = MESSAGE_ARROW_Y_OFFSET + m.startTs;
            const yPosEnd = MESSAGE_ARROW_Y_OFFSET + m.endTs;

            svg.append("g")
                .attr("transform", "translate(" + xPos + "," + yPosStart + ")")
                .attr("class", "first")
                .attr("text-anchor", "middle")
                .append("text")
                .style("font-size", "8px")
                .text(() => m.startTs);
            svg.append("g")
                .attr("transform", "translate(" + xPos + "," + yPosEnd + ")")
                .attr("class", "first")
                .attr("text-anchor", "middle")
                .append("text")
                .style("font-size", "8px")
                .text(() => m.endTs);
        });

        // Arrow style
        svg.append("svg:defs").selectAll("marker")
            .data(["end"])
            .enter().append("svg:marker")
            .attr("id", String)
            .attr("viewBox", "0 -5 10 10")
            .attr("refX", 10)
            .attr("refY", 0)
            .attr("markerWidth", 10)
            .attr("markerHeight", 10)
            .attr("orient", "auto")
            .append("svg:path")
            .attr("d", "M0,-5L10,0L0,5");
    }

    // Get data attach to window
    d3.json("data.json")
        .then(processData);

</script>
